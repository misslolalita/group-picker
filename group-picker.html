<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Group ‚Äì Balanced Picker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Animated background */
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #1d4ed8, #ec4899, #f97316, #22c55e);
      background-size: 400% 400%;
      animation: bgShift 18s ease infinite;
    }
    @keyframes bgShift {
      0%   { background-position: 0% 50%; }
      25%  { background-position: 50% 100%; }
      50%  { background-position: 100% 50%; }
      75%  { background-position: 50% 0%; }
      100% { background-position: 0% 50%; }
    }

    .card {
      background: rgba(255,255,255,0.96);
      padding: 28px 24px;
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.4);
      text-align: center;
      max-width: 360px;
      width: 88vw;
      backdrop-filter: blur(8px);
      position: relative;
      overflow: hidden;
    }

    h1 { font-size: 20px; margin-bottom: 6px; }
    .subtitle { font-size: 13px; color: #6b7280; margin-bottom: 18px; }

    .btn {
      padding: 12px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:disabled { opacity: 0.6; }

    .result {
      margin-top: 18px;
      min-height: 90px;
      opacity: 0;
      transform: translateY(16px) scale(0.9);
    }
    .result.visible {
      animation: popIn 0.6s cubic-bezier(0.19,1,0.22,1) forwards;
    }

    @keyframes popIn {
      0% { opacity: 0; transform: translateY(22px) scale(0.9); }
      50% { opacity: 1; transform: translateY(-4px) scale(1.05); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .group-label {
      font-size: 28px; font-weight: 800; letter-spacing: 0.04em;
      display: flex; align-items: center; gap: 10px;
    }

    .group-red .group-text { color: #b91c1c; }
    .group-orange .group-text { color: #c2410c; }
    .group-blue .group-text { color: #1d4ed8; }

    .emoji { font-size: 30px; }

    .sparkles {
      position: absolute; inset: 0; pointer-events: none;
    }
    .sparkle {
      position: absolute; font-size: 18px;
      animation: floatUp 1.8s ease-out forwards;
      opacity: 0;
    }
    @keyframes floatUp {
      0%   { transform: translateY(16px) scale(0.8); opacity: 0; }
      30%  { opacity: 1; }
      100% { transform: translateY(-28px) scale(1.1); opacity: 0; }
    }

    .status { font-size: 12px; color: #4b5563; margin-top: 8px; }
  </style>
</head>

<body>
  <div class="card">
    <h1>Your Group</h1>
    <p class="subtitle">Tap to reveal your color</p>

    <button class="btn" id="revealBtn">üé≤ Tap to see your group</button>

    <div class="result" id="resultBox"></div>
    <div class="status" id="statusText"></div>
    <div class="sparkles" id="sparkles"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    /*  ------------------------------
        üî• YOUR FIREBASE CONFIG (READY)
        ------------------------------ */
    const firebaseConfig = {
      apiKey: "AIzaSyDEsaf6zVAF6Zc623zkTis93GZXp8_hAU",
      authDomain: "group-picker.firebaseapp.com",
      databaseURL: "https://group-picker-default-rtdb.firebaseio.com",
      projectId: "group-picker",
      storageBucket: "group-picker.firebasestorage.app",
      messagingSenderId: "89320837110",
      appId: "1:89320837110:web:6b277751dc820f8fa3f057"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const countsRef = db.ref("groupCounts");

    const btn = document.getElementById("revealBtn");
    const resultBox = document.getElementById("resultBox");
    const sparkles = document.getElementById("sparkles");
    const statusText = document.getElementById("statusText");

    const groups = {
      red:    { name: "Red",    className: "group-red",    emoji: "üî¥" },
      orange: { name: "Orange", className: "group-orange", emoji: "üü†" },
      blue:   { name: "Blue",   className: "group-blue",   emoji: "üîµ" }
    };

    /* -----------------------------
       Returning players = same group
       ----------------------------- */
    const stored = localStorage.getItem("yourGroupKey");
    if (stored && groups[stored]) {
      showResult(groups[stored]);
      btn.disabled = true;
      btn.textContent = "Done ‚úÖ";
      statusText.textContent = "Welcome back!";
    }

    btn.addEventListener("click", () => {
      if (btn.disabled) return;

      const again = localStorage.getItem("yourGroupKey");
      if (again && groups[again]) {
        showResult(groups[again]);
        btn.disabled = true;
        btn.textContent = "Done ‚úÖ";
        return;
      }

      btn.disabled = true;
      btn.textContent = "Drawing...";
      statusText.textContent = "Please wait‚Ä¶";

      assignBalanced();
    });

    /* -------------------------------------------
       ‚≠ê Balanced assignment using transactions
       ------------------------------------------- */
    function assignBalanced() {
      let chosenKey = null;

      countsRef.transaction(current => {
        if (!current) {
          current = { red: 0, orange: 0, blue: 0 };
        }

        const entries = Object.entries(current);
        const values = entries.map(([k,v]) => v);
        const minVal = Math.min(...values);

        const candidates = entries
          .filter(([k,v]) => v === minVal)
          .map(([k]) => k);

        chosenKey = candidates[Math.floor(Math.random() * candidates.length)];
        current[chosenKey]++;

        return current;

      }, (error, committed) => {
        if (!committed || error) {
          statusText.textContent = "Error. Try again.";
          btn.disabled = false;
          btn.textContent = "üé≤ Try again";
          return;
        }

        const group = groups[chosenKey];
        localStorage.setItem("yourGroupKey", chosenKey);
        showResult(group);

        btn.textContent = "Done ‚úÖ";
        statusText.textContent = "Group assigned!";
      });
    }

    /* -----------------------------
       UI Updates
       ----------------------------- */
    function showResult(group) {
      resultBox.className = "result visible " + group.className;
      resultBox.innerHTML = `
        <div class="group-label">
          <span class="emoji">${group.emoji}</span>
          <span class="group-text">You're ${group.name}</span>
        </div>
      `;
      triggerSparkles();
    }

    function triggerSparkles() {
      sparkles.innerHTML = "";
      const icons = ["‚ú®","‚≠ê","üåü","üí´"];

      for (let i = 0; i < 8; i++) {
        const span = document.createElement("span");
        span.className = "sparkle";
        span.textContent = icons[Math.floor(Math.random() * icons.length)];
        span.style.left = Math.random() * 100 + "%";
        span.style.bottom = Math.random() * 40 + "px";
        span.style.animationDelay = Math.random() * 0.5 + "s";
        sparkles.appendChild(span);
      }
    }
  </script>
</body>
</html>
